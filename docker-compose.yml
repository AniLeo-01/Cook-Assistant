version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cook-assistant-backend
    command: >
      ${BACKEND_COMMAND:-python run_backend.py}
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=8080
      - MODAL_API_KEY=${MODAL_API_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DEBUG=${DEBUG:-false}
    volumes:
      # Mount source code (controlled by MOUNT_SOURCE env var)
      - ${MOUNT_SOURCE:+./src:/app/src}
      - ${MOUNT_SOURCE:+./run_backend.py:/app/run_backend.py}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: ${RESTART_POLICY:-unless-stopped}
    deploy:
      resources:
        limits:
          cpus: ${BACKEND_CPU_LIMIT:-2.0}
          memory: ${BACKEND_MEM_LIMIT:-2G}
        reservations:
          cpus: ${BACKEND_CPU_RESERVE:-1.0}
          memory: ${BACKEND_MEM_RESERVE:-1G}
    networks:
      - cook-assistant-network

  ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cook-assistant-ui
    command: >
      streamlit run src/app/ui/streamlit_app.py
      --server.port=8501
      --server.address=0.0.0.0
      --server.headless=true
      --browser.gatherUsageStats=false
      ${STREAMLIT_EXTRA_ARGS}
    ports:
      - "${UI_PORT:-8501}:8501"
    environment:
      - BACKEND_URL=http://backend:8080
      - DEBUG=${DEBUG:-false}
    volumes:
      # Mount source code (controlled by MOUNT_SOURCE env var)
      - ${MOUNT_SOURCE:+./src:/app/src}
    depends_on:
      backend:
        condition: service_healthy
    restart: ${RESTART_POLICY:-unless-stopped}
    deploy:
      resources:
        limits:
          cpus: ${UI_CPU_LIMIT:-1.0}
          memory: ${UI_MEM_LIMIT:-1G}
        reservations:
          cpus: ${UI_CPU_RESERVE:-0.5}
          memory: ${UI_MEM_RESERVE:-512M}
    networks:
      - cook-assistant-network

networks:
  cook-assistant-network:
    driver: bridge
